<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助教评估系统 - 项目提交</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .upload-area {
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .result-card {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- 头部 -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-6 py-8">
                <h1 class="text-4xl font-bold text-center">
                    <i class="fas fa-robot mr-3"></i>AI助教评估系统
                </h1>
                <p class="text-center mt-3 text-lg opacity-90">智能评估您的项目创意、UI设计和代码质量</p>
            </div>
        </header>

        <!-- 主要内容 -->
        <main class="container mx-auto px-6 py-12">
            <!-- 提交方式选择 -->
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">AI助教评估系统</h2>
                    <p class="text-gray-600 text-lg">支持项目提交评估和历史记录查询</p>
                </div>

                <!-- 选项卡 -->
                <div class="mb-8">
                    <div class="flex border-b">
                        <button 
                            @click="activeTab = 'upload'"
                            :class="['px-6 py-3 font-semibold text-lg border-b-2', 
                                    activeTab === 'upload' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500']">
                            <i class="fas fa-upload mr-2"></i>文件上传
                        </button>
                        <button 
                            @click="activeTab = 'git'"
                            :class="['px-6 py-3 font-semibold text-lg border-b-2 ml-8', 
                                    activeTab === 'git' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500']">
                            <i class="fab fa-git-alt mr-2"></i>Git仓库
                        </button>
                        <button 
                            @click="activeTab = 'history'"
                            :class="['px-6 py-3 font-semibold text-lg border-b-2 ml-8', 
                                    activeTab === 'history' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500']">
                            <i class="fas fa-history mr-2"></i>历史记录
                        </button>
                    </div>
                </div>

                <!-- 文件上传模式 -->
                <div v-show="activeTab === 'upload'" class="bg-white rounded-xl card-shadow p-8">
                    <form @submit.prevent="submitFiles" enctype="multipart/form-data">
                        <div class="space-y-6">
                            <!-- 学生信息 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">学生ID</label>
                                <input 
                                    v-model="uploadForm.studentId" 
                                    type="text" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="请输入学生ID">
                            </div>

                            <!-- 项目创意 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">项目创意描述</label>
                                <textarea 
                                    v-model="uploadForm.ideaText" 
                                    rows="6" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="请详细描述您的项目创意、目标用户、核心功能等..."></textarea>
                            </div>

                            <!-- 文件上传区域 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">上传项目文件</label>
                                <div 
                                    @dragover.prevent
                                    @drop.prevent="handleFileDrop"
                                    class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer"
                                    :class="{'border-blue-500 bg-blue-50': isDragging}"
                                    @dragenter="isDragging = true"
                                    @dragleave="isDragging = false">
                                    
                                    <div v-if="selectedFiles.length === 0">
                                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                                        <p class="text-xl text-gray-600 mb-2">拖拽文件到此处或点击选择</p>
                                        <p class="text-gray-500">支持 .zip, .tar.gz 压缩包或单个代码文件</p>
                                        <input 
                                            ref="fileInput"
                                            @change="handleFileSelect"
                                            type="file" 
                                            multiple 
                                            class="hidden"
                                            accept=".py,.js,.ts,.tsx,.jsx,.java,.cpp,.c,.zip,.tar.gz">
                                        <button 
                                            type="button"
                                            @click="$refs.fileInput.click()"
                                            class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                                            选择文件
                                        </button>
                                    </div>
                                    
                                    <div v-else>
                                        <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                                        <p class="text-xl text-green-600 mb-4">已选择 {{ selectedFiles.length }} 个文件</p>
                                        <div class="text-left bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
                                            <div v-for="file in selectedFiles" :key="file.name" class="flex items-center justify-between py-1">
                                                <span class="text-sm text-gray-700">{{ file.name }}</span>
                                                <span class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</span>
                                            </div>
                                        </div>
                                        <button 
                                            type="button"
                                            @click="clearFiles"
                                            class="mt-4 text-red-500 hover:text-red-600">
                                            <i class="fas fa-times mr-1"></i>清除文件
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 提交按钮 -->
                            <button 
                                type="submit"
                                :disabled="loading || selectedFiles.length === 0"
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-8 rounded-lg font-semibold text-lg
                                       hover:from-blue-600 hover:to-purple-700 transition duration-300 disabled:opacity-50">
                                <span v-if="loading">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>上传中...
                                </span>
                                <span v-else>
                                    <i class="fas fa-rocket mr-2"></i>提交项目评估
                                </span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Git仓库模式 -->
                <div v-show="activeTab === 'git'" class="bg-white rounded-xl card-shadow p-8">
                    <form @submit.prevent="submitGit">
                        <div class="space-y-6">
                            <!-- 学生信息 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">学生ID</label>
                                <input 
                                    v-model="gitForm.studentId" 
                                    type="text" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="请输入学生ID">
                            </div>

                            <!-- Git仓库URL -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Git仓库URL</label>
                                <input 
                                    v-model="gitForm.repoUrl" 
                                    type="url" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="https://github.com/username/project.git">
                            </div>

                            <!-- 分支名称 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">分支名称</label>
                                <input 
                                    v-model="gitForm.branch" 
                                    type="text"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="main (默认)">
                            </div>

                            <!-- 项目创意 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">项目创意描述</label>
                                <textarea 
                                    v-model="gitForm.ideaText" 
                                    rows="6" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="请详细描述您的项目创意、目标用户、核心功能等..."></textarea>
                            </div>

                            <!-- 提交按钮 -->
                            <button 
                                type="submit"
                                :disabled="loading"
                                class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-8 rounded-lg font-semibold text-lg
                                       hover:from-green-600 hover:to-blue-700 transition duration-300 disabled:opacity-50">
                                <span v-if="loading">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>克隆中...
                                </span>
                                <span v-else>
                                    <i class="fab fa-git-alt mr-2"></i>提交Git项目评估
                                </span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 历史记录模式 -->
                <div v-show="activeTab === 'history'" class="bg-white rounded-xl card-shadow p-8">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-history mr-2 text-blue-500"></i>评估历史记录
                        </h3>
                        
                        <!-- 筛选器 -->
                        <div class="flex flex-wrap gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">学生ID筛选</label>
                                <input 
                                    v-model="historyFilter.studentId" 
                                    type="text" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="输入学生ID筛选，留空显示全部">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">状态筛选</label>
                                <select 
                                    v-model="historyFilter.status" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">全部状态</option>
                                    <option value="completed">已完成</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="failed">已失败</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button 
                                    @click="loadHistory"
                                    :disabled="historyLoading"
                                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50">
                                    <i class="fas fa-search mr-2" :class="{'fa-spin': historyLoading}"></i>
                                    {{ historyLoading ? '加载中...' : '查询' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 历史记录列表 -->
                    <div v-if="historyData.length > 0">
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            <div 
                                v-for="record in filteredHistory" 
                                :key="record.assessment_id"
                                class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition"
                                @click="viewHistoryDetail(record)">
                                
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center mb-2">
                                            <h4 class="font-semibold text-gray-800">{{ record.student_id }}</h4>
                                            <span 
                                                :class="getStatusBadgeClass(record.status)"
                                                class="ml-3 px-2 py-1 rounded-full text-xs font-medium">
                                                {{ getStatusText(record.status) }}
                                            </span>
                                            <span v-if="record.overall_score" class="ml-2 text-sm text-gray-600">
                                                分数: {{ record.overall_score.toFixed(1) }}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2 line-clamp-2">
                                            {{ record.deliverables?.idea_text?.substring(0, 100) }}...
                                        </p>
                                        <div class="flex items-center text-xs text-gray-500">
                                            <i class="fas fa-clock mr-1"></i>
                                            <span>创建时间: {{ formatDateTime(record.created_at) }}</span>
                                            <span v-if="record.completed_at" class="ml-4">
                                                <i class="fas fa-check mr-1"></i>
                                                完成时间: {{ formatDateTime(record.completed_at) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 分页信息 -->
                        <div class="mt-6 text-center text-sm text-gray-600">
                            共显示 {{ filteredHistory.length }} 条记录
                            <span v-if="filteredHistory.length < historyData.length">
                                （已筛选，总共 {{ historyData.length }} 条）
                            </span>
                        </div>
                    </div>

                    <!-- 空状态 -->
                    <div v-else-if="!historyLoading && historyData.length === 0" class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl text-gray-500 mb-2">暂无评估记录</p>
                        <p class="text-gray-400">请先提交一些项目进行评估</p>
                    </div>

                    <!-- 加载状态 -->
                    <div v-else-if="historyLoading" class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-6xl text-blue-500 mb-4"></i>
                        <p class="text-xl text-gray-600">正在加载历史记录...</p>
                    </div>
                </div>
            </div>

            <!-- 评估结果显示 -->
            <div v-if="assessmentResult" class="max-w-6xl mx-auto mt-16">
                <div class="result-card bg-white rounded-xl card-shadow overflow-hidden">
                    <!-- 结果头部 -->
                    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6">
                        <h3 class="text-2xl font-bold mb-2">
                            <i class="fas fa-check-circle mr-3"></i>评估提交成功
                        </h3>
                        <p class="opacity-90">评估ID: {{ assessmentResult.assessment_id }}</p>
                    </div>

                    <div class="p-8">
                        <!-- 项目分析 -->
                        <div class="mb-8">
                            <h4 class="text-xl font-semibold mb-4 text-gray-800">
                                <i class="fas fa-chart-bar mr-2 text-blue-500"></i>项目分析
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-blue-600">{{ assessmentResult.analysis?.total_files || 0 }}</div>
                                    <div class="text-sm text-gray-600">总文件数</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-green-600">{{ assessmentResult.analysis?.code_files || 0 }}</div>
                                    <div class="text-sm text-gray-600">代码文件</div>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-purple-600">{{ assessmentResult.analysis?.lines_of_code || 0 }}</div>
                                    <div class="text-sm text-gray-600">代码行数</div>
                                </div>
                            </div>

                            <!-- 技术栈 -->
                            <div v-if="assessmentResult.analysis?.languages" class="mt-6">
                                <h5 class="font-semibold text-gray-700 mb-3">使用的编程语言:</h5>
                                <div class="flex flex-wrap gap-2">
                                    <span 
                                        v-for="(count, lang) in assessmentResult.analysis.languages" 
                                        :key="lang"
                                        class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                        {{ lang }} ({{ count }})
                                    </span>
                                </div>
                            </div>

                            <!-- 框架 -->
                            <div v-if="assessmentResult.analysis?.frameworks?.length" class="mt-4">
                                <h5 class="font-semibold text-gray-700 mb-3">检测到的框架:</h5>
                                <div class="flex flex-wrap gap-2">
                                    <span 
                                        v-for="framework in assessmentResult.analysis.frameworks" 
                                        :key="framework"
                                        class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                                        {{ framework }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 评估状态 -->
                        <div class="mb-6">
                            <h4 class="text-xl font-semibold mb-4 text-gray-800">
                                <i :class="getStatusIcon()" class="mr-2"></i>评估进度
                            </h4>
                            <div :class="getStatusClass()" class="p-4 rounded">
                                <p :class="getStatusTextClass()">
                                    {{ getStatusMessage() }}
                                    <button @click="checkAssessmentStatus" class="ml-4 text-blue-500 hover:text-blue-600">
                                        <i class="fas fa-sync-alt mr-1" :class="{'fa-spin': loading}"></i>刷新状态
                                    </button>
                                </p>
                                <div v-if="assessmentStatus === 'in_progress'" class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-orange-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="flex gap-4">
                            <button 
                                @click="handleResultAction"
                                :disabled="loading"
                                :class="getResultButtonClass()"
                                class="px-6 py-2 rounded-lg transition disabled:opacity-50">
                                <i :class="getResultButtonIcon()" class="mr-2"></i>{{ getResultButtonText() }}
                            </button>
                            <button 
                                @click="resetForm"
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-plus mr-2"></i>提交新项目
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 详细评估结果 -->
            <div v-if="detailedResult" class="max-w-6xl mx-auto mt-12">
                <div class="result-card bg-white rounded-xl card-shadow overflow-hidden">
                    <!-- 评分总览 -->
                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-6">
                        <h3 class="text-2xl font-bold mb-2">
                            <i class="fas fa-trophy mr-3"></i>评估结果
                        </h3>
                        <div class="text-3xl font-bold">总分: {{ detailedResult.overall_score?.toFixed(1) || 0 }}/100</div>
                    </div>

                    <div class="p-8">
                        <!-- 各维度评分 -->
                        <div class="mb-8">
                            <h4 class="text-xl font-semibold mb-6 text-gray-800">各维度评分</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center">
                                    <div class="text-4xl font-bold text-blue-500 mb-2">{{ detailedResult.breakdown?.idea?.toFixed(1) || 0 }}</div>
                                    <div class="text-gray-600 font-semibold">创意想法 (30%)</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                        <div class="bg-blue-500 h-2 rounded-full" :style="{width: (detailedResult.breakdown?.idea || 0) + '%'}"></div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl font-bold text-green-500 mb-2">{{ detailedResult.breakdown?.ui?.toFixed(1) || 0 }}</div>
                                    <div class="text-gray-600 font-semibold">UI设计 (30%)</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                        <div class="bg-green-500 h-2 rounded-full" :style="{width: (detailedResult.breakdown?.ui || 0) + '%'}"></div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl font-bold text-purple-500 mb-2">{{ detailedResult.breakdown?.code?.toFixed(1) || 0 }}</div>
                                    <div class="text-gray-600 font-semibold">代码质量 (40%)</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                        <div class="bg-purple-500 h-2 rounded-full" :style="{width: (detailedResult.breakdown?.code || 0) + '%'}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 详细子维度评分 -->
                        <div v-if="detailedResult.breakdown && (detailedResult.breakdown.idea_detail || detailedResult.breakdown.ui_detail || detailedResult.breakdown.code_detail)" class="mb-8">
                            <h4 class="text-xl font-semibold mb-6 text-gray-800">详细子维度评分</h4>
                            
                            <!-- 创意详细评分 -->
                            <div v-if="detailedResult.breakdown.idea_detail" class="mb-6">
                                <h5 class="text-lg font-semibold text-blue-600 mb-3">🧠 创意想法详细评分</h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">{{ detailedResult.breakdown.idea_detail.innovation || 0 }}</div>
                                        <div class="text-sm text-gray-600">创新性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-blue-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.idea_detail.innovation || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">{{ detailedResult.breakdown.idea_detail.feasibility || 0 }}</div>
                                        <div class="text-sm text-gray-600">可行性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-blue-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.idea_detail.feasibility || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">{{ detailedResult.breakdown.idea_detail.learning_value || 0 }}</div>
                                        <div class="text-sm text-gray-600">学习价值</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-blue-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.idea_detail.learning_value || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- UI详细评分 -->
                            <div v-if="detailedResult.breakdown.ui_detail" class="mb-6">
                                <h5 class="text-lg font-semibold text-green-600 mb-3">🎨 UI设计详细评分</h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600">{{ detailedResult.breakdown.ui_detail.compliance || 0 }}</div>
                                        <div class="text-sm text-gray-600">规范性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-green-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.ui_detail.compliance || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600">{{ detailedResult.breakdown.ui_detail.usability || 0 }}</div>
                                        <div class="text-sm text-gray-600">可用性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-green-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.ui_detail.usability || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600">{{ detailedResult.breakdown.ui_detail.information_arch || 0 }}</div>
                                        <div class="text-sm text-gray-600">信息架构</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-green-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.ui_detail.information_arch || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 代码详细评分 -->
                            <div v-if="detailedResult.breakdown.code_detail" class="mb-6">
                                <h5 class="text-lg font-semibold text-purple-600 mb-3">💻 代码质量详细评分</h5>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600">{{ detailedResult.breakdown.code_detail.correctness || 0 }}</div>
                                        <div class="text-sm text-gray-600">正确性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-purple-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.code_detail.correctness || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600">{{ detailedResult.breakdown.code_detail.readability || 0 }}</div>
                                        <div class="text-sm text-gray-600">可读性</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-purple-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.code_detail.readability || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600">{{ detailedResult.breakdown.code_detail.architecture || 0 }}</div>
                                        <div class="text-sm text-gray-600">架构设计</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-purple-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.code_detail.architecture || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-purple-600">{{ detailedResult.breakdown.code_detail.performance || 0 }}</div>
                                        <div class="text-sm text-gray-600">性能</div>
                                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                            <div class="bg-purple-500 h-1 rounded-full" :style="{width: (detailedResult.breakdown.code_detail.performance || 0) + '%'}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 改进建议 -->
                        <div v-if="detailedResult.diagnosis?.length" class="mb-8">
                            <h4 class="text-xl font-semibold mb-4 text-gray-800">
                                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>改进建议
                            </h4>
                            <div class="space-y-4">
                                <div 
                                    v-for="(diag, index) in detailedResult.diagnosis" 
                                    :key="index"
                                    class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                                    <div class="font-semibold text-yellow-800 mb-1">{{ diag.dim }}</div>
                                    <div class="text-yellow-700 mb-2">{{ diag.issue }}</div>
                                    <div class="text-yellow-600 text-sm">
                                        <strong>建议:</strong> {{ diag.fix }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 学习资源 -->
                        <div v-if="detailedResult.resources?.length" class="mb-8">
                            <h4 class="text-xl font-semibold mb-4 text-gray-800">
                                <i class="fas fa-book mr-2 text-green-500"></i>推荐学习资源
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div 
                                    v-for="resource in detailedResult.resources" 
                                    :key="resource"
                                    class="bg-green-50 text-green-700 px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>{{ resource }}
                                </div>
                            </div>
                        </div>

                        <!-- 准出规则 -->
                        <div v-if="detailedResult.exit_rules" class="mb-6">
                            <h4 class="text-xl font-semibold mb-4 text-gray-800">
                                <i class="fas fa-flag mr-2"></i>评估状态
                            </h4>
                            <div class="p-4 rounded-lg" :class="detailedResult.exit_rules.pass ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                                <div class="flex items-center mb-2">
                                    <i :class="detailedResult.exit_rules.pass ? 'fas fa-check-circle text-green-500' : 'fas fa-times-circle text-red-500'" class="mr-2"></i>
                                    <span class="font-semibold" :class="detailedResult.exit_rules.pass ? 'text-green-700' : 'text-red-700'">
                                        {{ detailedResult.exit_rules.pass ? '评估通过' : '需要改进' }}
                                    </span>
                                </div>
                                <div v-if="detailedResult.exit_rules.remedy?.length" class="text-sm" :class="detailedResult.exit_rules.pass ? 'text-green-600' : 'text-red-600'">
                                    <div v-for="remedy in detailedResult.exit_rules.remedy" :key="remedy" class="mt-1">
                                        • {{ remedy }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-gray-800 text-white py-8 mt-16">
            <div class="container mx-auto px-6 text-center">
                <p>&copy; 2024 AI助教评估系统. All rights reserved.</p>
                <p class="mt-2 text-gray-400">基于阿里云通义千问的智能评估平台</p>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    activeTab: 'upload',
                    loading: false,
                    isDragging: false,
                    selectedFiles: [],
                    assessmentResult: null,
                    detailedResult: null,
                    assessmentStatus: null,
                    pollingInterval: null,
                    uploadForm: {
                        studentId: '',
                        ideaText: ''
                    },
                    gitForm: {
                        studentId: '',
                        repoUrl: '',
                        branch: 'main',
                        ideaText: ''
                    },
                    // 历史记录相关数据
                    historyData: [],
                    historyLoading: false,
                    historyFilter: {
                        studentId: '',
                        status: ''
                    }
                }
            },
            computed: {
                // 筛选后的历史记录
                filteredHistory() {
                    let filtered = this.historyData
                    
                    // 按学生ID筛选
                    if (this.historyFilter.studentId) {
                        const studentId = this.historyFilter.studentId.toLowerCase().trim()
                        filtered = filtered.filter(record => 
                            record.student_id.toLowerCase().includes(studentId)
                        )
                    }
                    
                    // 按状态筛选
                    if (this.historyFilter.status) {
                        filtered = filtered.filter(record => 
                            record.status === this.historyFilter.status
                        )
                    }
                    
                    return filtered
                }
            },
            methods: {
                handleFileSelect(event) {
                    this.selectedFiles = Array.from(event.target.files)
                },
                handleFileDrop(event) {
                    this.isDragging = false
                    this.selectedFiles = Array.from(event.dataTransfer.files)
                },
                clearFiles() {
                    this.selectedFiles = []
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = ''
                    }
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B'
                    const k = 1024
                    const sizes = ['B', 'KB', 'MB', 'GB']
                    const i = Math.floor(Math.log(bytes) / Math.log(k))
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
                },
                async submitFiles() {
                    if (!this.uploadForm.studentId || !this.uploadForm.ideaText || this.selectedFiles.length === 0) {
                        alert('请填写所有必填信息并选择文件')
                        return
                    }

                    this.loading = true
                    try {
                        const formData = new FormData()
                        formData.append('student_id', this.uploadForm.studentId)
                        formData.append('idea_text', this.uploadForm.ideaText)
                        
                        this.selectedFiles.forEach(file => {
                            formData.append('files', file)
                        })

                        const response = await fetch('/api/upload/files', {
                            method: 'POST',
                            body: formData
                        })

                        if (response.ok) {
                            const result = await response.json()
                            this.assessmentResult = result
                            this.assessmentStatus = 'queued'  // 初始状态
                            this.startPolling()  // 开始轮询
                            this.scrollToResult()
                        } else {
                            const error = await response.json()
                            alert('提交失败: ' + (error.detail || '未知错误'))
                        }
                    } catch (error) {
                        alert('提交失败: ' + error.message)
                    } finally {
                        this.loading = false
                    }
                },
                async submitGit() {
                    if (!this.gitForm.studentId || !this.gitForm.repoUrl || !this.gitForm.ideaText) {
                        alert('请填写所有必填信息')
                        return
                    }

                    this.loading = true
                    try {
                        const response = await fetch('/api/upload/git', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                student_id: this.gitForm.studentId,
                                repo_url: this.gitForm.repoUrl,
                                branch: this.gitForm.branch || 'main',
                                idea_text: this.gitForm.ideaText
                            })
                        })

                        if (response.ok) {
                            const result = await response.json()
                            this.assessmentResult = result
                            this.assessmentStatus = 'queued'  // 初始状态
                            this.startPolling()  // 开始轮询
                            this.scrollToResult()
                        } else {
                            const error = await response.json()
                            alert('提交失败: ' + (error.detail || '未知错误'))
                        }
                    } catch (error) {
                        alert('提交失败: ' + error.message)
                    } finally {
                        this.loading = false
                    }
                },
                async checkAssessmentStatus() {
                    if (!this.assessmentResult?.assessment_id) return

                    this.loading = true
                    try {
                        const response = await fetch(`/api/assessment/${this.assessmentResult.assessment_id}`)
                        if (response.ok) {
                            const result = await response.json()
                            this.assessmentStatus = result.status
                            
                            if (result.status === 'completed') {
                                this.detailedResult = result
                                this.stopPolling()
                            } else if (result.status === 'failed') {
                                this.stopPolling()
                            }
                        } else {
                            console.error('获取评估状态失败')
                        }
                    } catch (error) {
                        console.error('检查评估状态失败:', error)
                    } finally {
                        this.loading = false
                    }
                },
                startPolling() {
                    // 清除之前的轮询
                    this.stopPolling()
                    
                    // 立即检查一次状态
                    this.checkAssessmentStatus()
                    
                    // 每3秒检查一次状态
                    this.pollingInterval = setInterval(() => {
                        if (this.assessmentStatus !== 'completed' && this.assessmentStatus !== 'failed') {
                            this.checkAssessmentStatus()
                        }
                    }, 3000)
                },
                stopPolling() {
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval)
                        this.pollingInterval = null
                    }
                },
                handleResultAction() {
                    if (this.assessmentStatus === 'completed') {
                        // 如果已完成，滚动到详细结果
                        this.scrollToDetailedResult()
                    } else {
                        // 如果未完成，检查状态
                        this.checkAssessmentStatus()
                    }
                },
                getStatusIcon() {
                    switch (this.assessmentStatus) {
                        case 'completed':
                            return 'fas fa-check-circle text-green-500'
                        case 'failed':
                            return 'fas fa-times-circle text-red-500'
                        case 'in_progress':
                            return 'fas fa-cog fa-spin text-orange-500'
                        default:
                            return 'fas fa-clock text-gray-500'
                    }
                },
                getStatusClass() {
                    switch (this.assessmentStatus) {
                        case 'completed':
                            return 'bg-green-50 border-l-4 border-green-400'
                        case 'failed':
                            return 'bg-red-50 border-l-4 border-red-400'
                        case 'in_progress':
                            return 'bg-orange-50 border-l-4 border-orange-400'
                        default:
                            return 'bg-gray-50 border-l-4 border-gray-400'
                    }
                },
                getStatusTextClass() {
                    switch (this.assessmentStatus) {
                        case 'completed':
                            return 'text-green-700'
                        case 'failed':
                            return 'text-red-700'
                        case 'in_progress':
                            return 'text-orange-700'
                        default:
                            return 'text-gray-700'
                    }
                },
                getStatusMessage() {
                    switch (this.assessmentStatus) {
                        case 'completed':
                            return '✅ 评估已完成！点击下方按钮查看详细结果'
                        case 'failed':
                            return '❌ 评估失败，请检查提交的项目或重新提交'
                        case 'in_progress':
                            return '⏳ 评估正在进行中，AI正在分析您的项目...'
                        case 'queued':
                            return '📋 评估已排队，正在准备开始...'
                        default:
                            return '📋 准备开始评估...'
                    }
                },
                getResultButtonClass() {
                    return this.assessmentStatus === 'completed' 
                        ? 'bg-green-500 text-white hover:bg-green-600'
                        : 'bg-blue-500 text-white hover:bg-blue-600'
                },
                getResultButtonIcon() {
                    return this.assessmentStatus === 'completed' 
                        ? 'fas fa-trophy' 
                        : 'fas fa-sync-alt'
                },
                getResultButtonText() {
                    return this.assessmentStatus === 'completed' 
                        ? '查看详细结果' 
                        : '刷新评估状态'
                },
                scrollToResult() {
                    this.$nextTick(() => {
                        const element = document.querySelector('.result-card')
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth' })
                        }
                    })
                },
                scrollToDetailedResult() {
                    this.$nextTick(() => {
                        const element = document.querySelector('.result-card:last-child')
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth' })
                        }
                    })
                },
                resetForm() {
                    this.stopPolling()  // 停止轮询
                    this.assessmentResult = null
                    this.detailedResult = null
                    this.assessmentStatus = null
                    this.selectedFiles = []
                    this.uploadForm = { studentId: '', ideaText: '' }
                    this.gitForm = { studentId: '', repoUrl: '', branch: 'main', ideaText: '' }
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = ''
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' })
                },
                // ================== 历史记录相关方法 ==================
                async loadHistory() {
                    this.historyLoading = true
                    try {
                        let url = '/api/assessment/history'
                        const params = new URLSearchParams()
                        
                        if (this.historyFilter.studentId.trim()) {
                            params.append('student_id', this.historyFilter.studentId.trim())
                        }
                        params.append('limit', '100') // 默认获取100条记录
                        
                        if (params.toString()) {
                            url += '?' + params.toString()
                        }
                        
                        const response = await fetch(url)
                        if (response.ok) {
                            const data = await response.json()
                            this.historyData = data.assessments || []
                        } else {
                            const error = await response.json()
                            throw new Error(error.detail || '获取历史记录失败')
                        }
                    } catch (error) {
                        console.error('加载历史记录失败:', error)
                        alert('加载历史记录失败: ' + error.message)
                    } finally {
                        this.historyLoading = false
                    }
                },
                viewHistoryDetail(record) {
                    // 复用现有的详细结果展示
                    if (record.status === 'completed') {
                        this.detailedResult = {
                            overall_score: record.overall_score,
                            breakdown: record.breakdown,  // 修正字段名
                            diagnosis: record.diagnosis || [],
                            resources: record.resources || [],
                            exit_rules: record.exit_rules
                        }
                        
                        // 滚动到详细结果
                        this.scrollToDetailedResult()
                    } else {
                        // 如果不是完成状态，显示基本信息
                        this.assessmentResult = {
                            assessment_id: record.assessment_id,
                            analysis: {
                                total_files: 0,
                                code_files: 0,
                                lines_of_code: 0,
                                languages: {},
                                frameworks: []
                            }
                        }
                        this.assessmentStatus = record.status
                        this.detailedResult = null
                        
                        // 滚动到结果区域
                        this.scrollToResult()
                        
                        // 如果是进行中状态，可以开始轮询
                        if (record.status === 'in_progress') {
                            this.startPolling()
                        }
                    }
                },
                getStatusText(status) {
                    const statusMap = {
                        'completed': '已完成',
                        'in_progress': '进行中',
                        'queued': '排队中',
                        'failed': '失败'
                    }
                    return statusMap[status] || status
                },
                getStatusBadgeClass(status) {
                    const classMap = {
                        'completed': 'bg-green-100 text-green-800',
                        'in_progress': 'bg-orange-100 text-orange-800',
                        'queued': 'bg-blue-100 text-blue-800',
                        'failed': 'bg-red-100 text-red-800'
                    }
                    return classMap[status] || 'bg-gray-100 text-gray-800'
                },
                formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return ''
                    try {
                        const date = new Date(dateTimeStr)
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    } catch {
                        return dateTimeStr
                    }
                }
            },
            watch: {
                // 监听标签页切换，自动加载历史记录
                activeTab(newTab) {
                    if (newTab === 'history' && this.historyData.length === 0) {
                        this.loadHistory()
                    }
                }
            },
            // 组件销毁时清理轮询
            beforeUnmount() {
                this.stopPolling()
            }
        }).mount('#app')
    </script>
</body>
</html>
