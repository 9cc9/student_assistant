<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>诊断历史测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-8">
    <div id="app">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">
                <i class="fas fa-stethoscope text-purple-600 mr-3"></i>诊断历史测试
            </h1>
            
            <!-- 登录表单 -->
            <div v-if="!isLoggedIn" class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">测试账号登录</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">学生ID</label>
                        <input v-model="loginForm.student_id" type="text" 
                            class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="test_history_001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input v-model="loginForm.password" type="password" 
                            class="w-full px-4 py-2 border rounded-lg" 
                            placeholder="test123">
                    </div>
                    <button @click="login" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-sign-in-alt mr-2"></i>登录
                    </button>
                    <p v-if="error" class="text-red-600 text-sm">{{ error }}</p>
                </div>
            </div>
            
            <!-- 已登录状态 -->
            <div v-else>
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="text-sm text-gray-600">当前用户</p>
                            <p class="text-lg font-semibold">{{ currentStudent.name }} ({{ currentStudent.student_id }})</p>
                        </div>
                        <button @click="logout" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            <i class="fas fa-sign-out-alt mr-2"></i>登出
                        </button>
                    </div>
                    
                    <button @click="loadDiagnosticHistory" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 mb-4">
                        <i class="fas fa-sync mr-2"></i>刷新诊断历史
                    </button>
                </div>
                
                <!-- 诊断历史 -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">
                        <i class="fas fa-history text-purple-600 mr-2"></i>诊断历史
                    </h2>
                    
                    <!-- 加载中 -->
                    <div v-if="loading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-purple-600 text-2xl"></i>
                        <p class="text-gray-600 mt-2">加载中...</p>
                    </div>
                    
                    <!-- 诊断历史列表 -->
                    <div v-else-if="diagnosticHistory.length > 0" class="space-y-4">
                        <div v-for="(record, index) in diagnosticHistory" :key="record.test_id" 
                            class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-200">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">第 {{ index + 1 }} 次测试</p>
                                    <p class="font-semibold text-gray-800">{{ formatDateTime(record.submitted_at) }}</p>
                                </div>
                                <span :class="['px-3 py-1 rounded-full text-sm font-semibold',
                                    record.overall_readiness === '优秀' ? 'bg-green-100 text-green-700' :
                                    record.overall_readiness === '良好' ? 'bg-blue-100 text-blue-700' :
                                    record.overall_readiness === '合格' ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-orange-100 text-orange-700']">
                                    {{ record.overall_readiness }}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center bg-white/50 rounded-lg p-3">
                                    <p class="text-2xl font-bold text-purple-600">{{ record.concept_score }}</p>
                                    <p class="text-xs text-gray-600 mt-1">概念理解</p>
                                </div>
                                <div class="text-center bg-white/50 rounded-lg p-3">
                                    <p class="text-2xl font-bold text-blue-600">{{ record.coding_score }}</p>
                                    <p class="text-xs text-gray-600 mt-1">编程能力</p>
                                </div>
                                <div class="text-center bg-white/50 rounded-lg p-3">
                                    <p class="text-2xl font-bold text-pink-600">{{ record.tool_familiarity }}</p>
                                    <p class="text-xs text-gray-600 mt-1">工具熟悉度</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                        <i class="fas fa-layer-group mr-1"></i>{{ record.learning_level }}通道
                                    </span>
                                    <span class="text-gray-600">
                                        <i class="fas fa-heart mr-1"></i>{{ record.learning_style }}
                                    </span>
                                </div>
                                <span class="text-gray-500 text-xs">ID: {{ record.test_id.slice(-12) }}</span>
                            </div>
                            
                            <div v-if="record.interests && record.interests.length > 0" class="mt-3 pt-3 border-t border-purple-200">
                                <p class="text-xs text-gray-600 mb-2">兴趣领域:</p>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="interest in record.interests" :key="interest" 
                                        class="px-2 py-1 bg-white text-purple-600 rounded-full text-xs">
                                        {{ interest }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 空状态 -->
                    <div v-else class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">暂无诊断记录</p>
                    </div>
                    
                    <!-- 调试信息 -->
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">调试信息:</p>
                        <p class="text-xs text-gray-600">记录数量: {{ diagnosticHistory.length }}</p>
                        <p class="text-xs text-gray-600">加载状态: {{ loading ? '加载中' : '已完成' }}</p>
                        <p class="text-xs text-gray-600">Token: {{ authToken ? authToken.slice(0, 30) + '...' : '无' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    currentStudent: null,
                    authToken: null,
                    loginForm: {
                        student_id: 'test_history_001',
                        password: 'test123'
                    },
                    diagnosticHistory: [],
                    loading: false,
                    error: ''
                }
            },
            methods: {
                async login() {
                    this.error = ''
                    this.loading = true
                    
                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        })
                        
                        const data = await response.json()
                        
                        if (data.success) {
                            this.authToken = data.token
                            this.currentStudent = data.student
                            this.isLoggedIn = true
                            
                            console.log('✅ 登录成功')
                            await this.loadDiagnosticHistory()
                        } else {
                            this.error = data.message || '登录失败'
                        }
                    } catch (error) {
                        console.error('登录失败:', error)
                        this.error = error.message
                    } finally {
                        this.loading = false
                    }
                },
                
                async loadDiagnosticHistory() {
                    if (!this.authToken) {
                        console.warn('⚠️ 没有Token，无法加载诊断历史')
                        return
                    }
                    
                    this.loading = true
                    this.error = ''
                    
                    try {
                        console.log('📡 开始加载诊断历史...')
                        const response = await fetch('/api/student/diagnostic-history?limit=10', {
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`
                            }
                        })
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                        }
                        
                        const data = await response.json()
                        console.log('📊 诊断历史数据:', data)
                        
                        this.diagnosticHistory = data.history || []
                        console.log(`✅ 加载成功: ${this.diagnosticHistory.length} 条记录`)
                    } catch (error) {
                        console.error('❌ 加载诊断历史失败:', error)
                        this.error = error.message
                    } finally {
                        this.loading = false
                    }
                },
                
                logout() {
                    this.isLoggedIn = false
                    this.currentStudent = null
                    this.authToken = null
                    this.diagnosticHistory = []
                    console.log('👋 已登出')
                },
                
                formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return ''
                    try {
                        const date = new Date(dateTimeStr)
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    } catch {
                        return dateTimeStr
                    }
                }
            },
            mounted() {
                console.log('🚀 诊断历史测试页面已加载')
            }
        }).mount('#app')
    </script>
</body>
</html>


